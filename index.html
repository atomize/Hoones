<html>
	<head>
		<title>test</title>
		<link href="./css/foundation.css" rel="stylesheet">
		<style>
			body {
				background-color: #000;
			}

			li div, label {
				min-width: 150px; !important;
				font-weight: bold;
				color: #ffffff;
				display: inline-block;
				margin: 0px;
			}

			ul {
				margin: 0px;
				padding: 0px;
			}

			fieldset {
				color: #fff;
				padding: 10px;
				margin: 10px;
			}

		</style>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	</head>
	<body>
	<div class="row">
		<div class="small-12 large-12 columns">

			<button onclick="tick();">Tick</button>
		</div>
	</div>

	<div class="row">
		<div class="small-6 large-6 columns">
			<fieldset>
				<legend>Screen</legend>
				<canvas id="screen" width="200" height="100" style="display: block;"></canvas>
			</fieldset>
			<fieldset>
				<legend>Console</legend>
				<div style="color: #bebebe; display: inline-block">
					<ul style="list-style: none;">
						<li><div>CPU Cycles: </div><span id="cpucycles"></span></li>
						<li><div>PPU Cycles: </div><span id="ppucycles"></span></li>
						<li><div>Scanline: </div><span id="scanline"></span></li>
						<li><div>Ticks: </div><span id="ticks"></span></li>
					</ul>
				</div>
			</fieldset>
			<fieldset>
				<legend>Operation</legend>
				<div style="color: #bebebe; display: inline-block">
					<ul style="list-style: none;">
						<li><div>Opcode: </div><span id="opcode"></span></li>
						<li><div>Op: </div><span id="opname"></span></li>
						<li><div>Mode: </div><span id="mode"></span></li>
						<li><div>Address: </div><span id="opaddr"></span></li>
					</ul>
				</div>
			</fieldset>

		</div>
		<div class="small-6 large-6 columns">
			<fieldset>
				<legend>Nametable</legend>
				<canvas id="nametables" width="200" height="200" style="display: block;"></canvas>
			</fieldset>
		</div>	

	</div>


	<div class="row">
		<div class="small-6 large-6 columns">
			<fieldset class="border">
				<legend>CPU</legend>
				<div style="color: #bebebe; ">
					<div style="margin-bottom: 10px">
						<ul style="list-style: none;">
							<li><label>PC: </label><span id="pc"></span></li>
						</ul>
					</div>
					<ul style="list-style: none;">
						<li></li>
						<li><div>Accumulator: </div><span id="acc"></span></li>
						<li><div>X: </div><span id="x"></span></li>
						<li><div>Y: </div><span id="y"></span></li>
						<li><div>SP: </div><span id="sp"></span></li>
						<li><div>P: </div><span id="pflags"></span></li>
					<ul style="list-style: none;margin-left: 20px; margin-top: 10px; margin-bottom: 10px">
						<li><div>carry flag:</div><span id="carryFlag"></span></li>
						<li><div>zero flag:</div><span id="zeroFlag"></span></li>
						<li><div>interrupt flag:</div><span id="interruptFlag"></span></li>
						<li><div>decimal </div><span id="decimalFlag"></span></li>
						<li><div>break flag:</div><span id="breakFlag"></span></li>
						<li><div>overflow flag:</div><span id="overflowFlag"></span></li>
						<li><div>negative flag:</div><span id="negativeFlag"></span></li>
					</ul>						
					</ul>
				</div>


				<div style="color: #bebebe;">
					<label>Stack: </label>
					<span id="stack"></span>
				</div>

			</fieldset>
		</div>
		<div class="small-6 large-6 columns" >
		<fieldset style="width: 535px;">
			<legend>PPU</legend>

			<div style="color: #bebebe; display: inline-block">
				<div style="margin-bottom: 10px">
					<ul style="list-style: none;">
						<li>
							<label>VRAM Address: </label><span id="vram"></span>
						</li>
						<li>
							<label>Temp Address: </label><span id="temp"></span>
						</li>
						<li>
							<label>OAM Address: </label><span id="val0"></span>
						</li>
						<li>
							<label>Name Table Address: </label><span id="nameaddr"></span>
						</li>
						<li>
							<label>NameTable Byte: </label><span id="namebyte"></span>
						</li>						
						<li>
							<label>Tile Address: </label><span id="tileaddr"></span>
						</li>		
						<li>
							<label>Tile Byte: </label><span id="tilebyte"></span>
						</li>							
						<li>
							<label>X-Pos: </label><span id="xpos"></span>
						</li>
						<li>
							<label>Y-Pos: </label><span id="ypos"></span>
						</li>
					</ul>
				</div>			
			
				<ul style="list-style: none;">
					<li>
						<div>control:</div><span id="cnrtl1">(0x2000)</span><br/>
						<ul style="list-style: none;  margin-left: 20px; margin-top: 10px; margin-bottom: 10px">
							<li><div>nametable:</div><span id="nametable"></span></li>
							<li><div>increment:</div><span id="increment"></span></li>
							<li><div>sprite table:</div><span id="spritetable"></span></li>
							<li><div>background table:</div><span id="backgroundtable"></span></li>
							<li><div>sprite size:</div><span id="spritesize"></span></li>
							<li><div>masterslave:</div><span id="masterslave"></span></li>
							<li><div>nmi:</div><span id="nmi"></span></li>
						</ul>
					</li>



					<li><div>mask: </div><span id="mask">(0x2001)</span>
						<ul style="list-style: none;  margin-left: 20px; margin-top: 10px; margin-bottom: 10px">
							<li><div>greyscale:</div><span id="grayscale"></span></li>
							<li><div>showbgleft:</div><span id="showbgleft"></span></li>
							<li><div>showspleft:</div><span id="showspleft"></span></li>
							<li><div>showbg:</div><span id="showbg"></span></li>
							<li><div>showsprites:</div><span id="showsprites"></span></li>
							<li><div>increds:</div><span id="increds"></span></li>
							<li><div>incgreens:</div><span id="incgreens"></span></li>
							<li><div>incblues:</div><span id="incblues"></span></li>
						</ul>
					</li>
					<li>
						<div>status:</div>
						<span id="status">(0x2002)</span>
						<ul style="list-style: none;  margin-left: 20px; margin-top: 10px; margin-bottom: 10px">
							<li><div>spriteoverflow:</div><span id="spriteoverflow"></span></li>
							<li><div>spritehit:</div><span id="spritehit"></span></li>
							<li><div>vblank:</div><span id="vblank"></span></li>
							<li><div>nmiOccurred:</div><span id="nmiOccurred"></span></li>
							<li><div>writable:</div><span id="writable"></span></li>
						</ul>
					</li>
					<li>
						<div>scroll:</div><span id="scroll">(0x2005)</span>
						<ul style="list-style: none;  margin-left: 20px; margin-top: 10px; margin-bottom: 10px">
							<li><div>val:</div><span id="val"></span></li>
						</ul>
					</li>
				</ul>
			</div>

		</fieldset>
		</div>
	</div>

	<div id="log">

	</div>

	<script type="text/javascript" src="js/hoones/lib/BinFileReader.js"></script>
	<script type="text/javascript" src="js/hoones/cartridge.js"></script>
	<script type="text/javascript" src="js/hoones/cpu.js"></script>
	<script type="text/javascript" src="js/hoones/ppu.js"></script>
	<script type="text/javascript" src="js/hoones/nes.js"></script>
	<script type="text/javascript">

		nes.load("./roms/palette_ram.nes");
		nes.reset();
		
	</script>

	<script type="text/javascript">

		function regStatus() {


			document.getElementById("carryFlag").innerHTML = cpu.registers.p.c == 1;
			document.getElementById("zeroFlag").innerHTML = cpu.registers.p.z == 1;
			document.getElementById("interruptFlag").innerHTML = cpu.registers.p.i == 1;
			document.getElementById("decimalFlag").innerHTML = cpu.registers.p.d == 1;
			document.getElementById("breakFlag").innerHTML = cpu.registers.p.b == 1;
			document.getElementById("overflowFlag").innerHTML = cpu.registers.p.v == 1;
			document.getElementById("negativeFlag").innerHTML = cpu.registers.p.n == 1;

			document.getElementById("pc").innerHTML = "0x" + cpu.registers.pc.get().toString(16).toUpperCase();
			document.getElementById("acc").innerHTML = "0x" + cpu.registers.a.get().toString(16).toUpperCase();
			document.getElementById("x").innerHTML = "0x" + cpu.registers.x.get().toString(16).toUpperCase();
			document.getElementById("y").innerHTML = "0x" + cpu.registers.y.get().toString(16).toUpperCase();
			document.getElementById("sp").innerHTML = "0x" + cpu.registers.sp.get().toString(16).toUpperCase();
			document.getElementById("pflags").innerHTML = "0x" + cpu.registers.p.get().toString(16).toUpperCase();

			document.getElementById("nametable").innerHTML = "0x" + ppu.registers.cntrl.nametable;
			document.getElementById("increment").innerHTML = "0x" + ppu.registers.cntrl.increment;
			document.getElementById("spritetable").innerHTML = "0x" + ppu.registers.cntrl.spritetable;
			document.getElementById("backgroundtable").innerHTML = "0x" + ppu.registers.cntrl.backgroundtable;
			document.getElementById("spritesize").innerHTML = "0x" + ppu.registers.cntrl.spritesize;
			document.getElementById("masterslave").innerHTML = "0x" + ppu.registers.cntrl.masterslave;
			document.getElementById("nmi").innerHTML = "0x" + ppu.registers.cntrl.nmi;

			document.getElementById("grayscale").innerHTML = "0x" + ppu.registers.mask.greyscale;
			document.getElementById("showbgleft").innerHTML = "0x" + ppu.registers.mask.showbgleft;
			document.getElementById("showspleft").innerHTML = "0x" + ppu.registers.mask.showspleft;
			document.getElementById("showbg").innerHTML = "0x" + ppu.registers.mask.showbg;
			document.getElementById("showsprites").innerHTML = "0x" + ppu.registers.mask.showsprites;
			document.getElementById("increds").innerHTML = "0x" + ppu.registers.mask.increds;
			document.getElementById("incgreens").innerHTML = "0x" + ppu.registers.mask.incgreens;
			document.getElementById("incblues").innerHTML = "0x" + ppu.registers.mask.incblues;

			document.getElementById("spriteoverflow").innerHTML = "0x" + ppu.registers.status.spriteoverflow;
			document.getElementById("spritehit").innerHTML = "0x" + ppu.registers.status.spritehit;
			document.getElementById("vblank").innerHTML = "0x" + ppu.registers.status.vblank;
			document.getElementById("nmiOccurred").innerHTML = "0x" + ppu.nmi.occurred ? 1:0 ;
			document.getElementById("writable").innerHTML = "0x" + ppu.vars.w;

			document.getElementById("val").innerHTML = "0x" + ppu.registers.scroll.data.toString(16).toUpperCase();

			document.getElementById("vram").innerHTML = "0x" + ppu.vars.v.toString(16).toUpperCase();
			document.getElementById("temp").innerHTML = "0x" + ppu.vars.t.toString(16).toUpperCase();
			document.getElementById("xpos").innerHTML = "0x" + ppu.background.xpos.toString(16).toUpperCase();
			document.getElementById("ypos").innerHTML = "0x" + ppu.background.ypos.toString(16).toUpperCase();
			document.getElementById("nameaddr").innerHTML = "0x" + ppu.background.nameTableAddr.toString(16).toUpperCase();
			document.getElementById("tileaddr").innerHTML = "0x" + ppu.background.fetchTileAddr().toString(16).toUpperCase();
			document.getElementById("namebyte").innerHTML = "0x" + ppu.background.nameTableByte.toString(16).toUpperCase();
			document.getElementById("tilebyte").innerHTML = "0x" + ppu.mmu.readByte(ppu.background.fetchTileAddr()).toString(16).toUpperCase();
			 
			 
			var st = "";
			var comma = " ,";
			for (var i = cpu.mmu.stack.data.length - 1; i >= cpu.registers.sp.get(); i--) {

				if (i == 0) {
					comma = "";
				}
				var result = cpu.mmu.stack.data[i];
				if (typeof result == 'undefined') {
					st += "0" + comma;
				} else {
					st += cpu.mmu.stack.data[i].toString(16) + comma;
				}
			}

			document.getElementById("stack").innerHTML = st;

			var op = cpu.op;
			if (op) {
				document.getElementById("opcode").innerHTML = "0x" + cpu.op.opcode.toString(16).toUpperCase();
				document.getElementById("opname").innerHTML = cpu.op.op.name;
				document.getElementById("mode").innerHTML = cpu.op.op.mode.toUpperCase();
				document.getElementById("opaddr").innerHTML = "0x" + cpu.op.address.toString(16).toUpperCase();
			} else {
				document.getElementById("opcode").innerHTML = "NULL";
				document.getElementById("opname").innerHTML = "NULL";
				document.getElementById("mode").innerHTML = "NULL";
				document.getElementById("opaddr").innerHTML = "NULL";
			}

			document.getElementById("cpucycles").innerHTML = cpu.cycles;
			document.getElementById("ppucycles").innerHTML = ppu.cycle;
			document.getElementById("scanline").innerHTML = ppu.scanline;
			document.getElementById("ticks").innerHTML = cpu.ticks;

		};

		function opCodeUpdate(val) {
			if (val && val.opcode) {
				document.getElementById("opcode").innerHTML = val.opcode.name;
				document.getElementById("opaddr").innerHTML = val.address.toString(16).toUpperCase();
			}
		};

		function tick() {
			nes.tick();
			regStatus();
		};

		function tickFor(val) {
			nes.tickFor(val);
			regStatus();
		};

		$(window).keypress(function (e) {
			if (e.keyCode === 0 || e.keyCode === 32) {
				e.preventDefault();
				tick();
			}
		});


	</script>	
	

	<script type="text/javascript">
		var nametable = {
		
			canvas : null,
			
			init : function() {
				var c = document.getElementById('nametables');	
				c.width  = 511;
				c.height = 555;
				this.canvas = c.getContext('2d');					

			},
			
			draw : function(nametables) {


				for (var nameTablesIndex = 0; nameTablesIndex < 1; nameTablesIndex++) {
					var nameTable = nametables[nameTablesIndex];


					var xpos = 0;
					var ypos = 0;
					var width = 0;
					for (var nameTableIndex = 0; nameTableIndex < nameTable.length; nameTableIndex++) {
						var nameTableByte = nameTable[nameTableIndex];

						var endX = xpos + 8;
						var endY = ypos + 8;

						for (; ypos < endY; ypos++) {
						
							var address = (nameTableByte*16) + ypos;
							console.log(address.toString(16));
							var patternByte = ppu.mmu.readByte(address);
						
							for (; xpos < endX; xpos++) {

								var pixelBit = patternByte & 0x1;
								if (pixelBit != 0) {
									this.setPixel(xpos, ypos, "#FFFFFF");
								}

								patternByte >>= 1;

								
							}
							xpos = xpos - 8;
							

						}
						width++;
						if (width == 30) {
							ypos = ypos + 8;
							width = 0;
							xpos = xpos - 240;
						}
					}
				}
			},
			
			setPixel: function(x, y, hex) {
				var color = hex;

				this.canvas.fillStyle = color;
				this.canvas.fillRect(
					x, 
					y, 
					1,
					1
				);
			}
		};
		nametable.init();
		//nametable.init();
		//nametable.draw([[],[],[],[]]);
	</script>
	


	</body>
</html>